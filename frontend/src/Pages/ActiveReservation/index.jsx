import { useEffect } from 'react';
import { useSelector, useDispatch } from 'react-redux';
import InfoPlace from '../../components/ActiveReselve/InfoPlace';
import NumberPlace from '../../components/ActiveReselve/NumberPlace';
import {
  setInfoActiveReselve,
  setNumberPlace,
  setDateStart,
  setDateEnd,
  setFirstName,
  setCheckData,
  setLoading,
  setRoom,
  setRemainingTime,
  setDeleteReservation,
  setMessageCompleted,
} from '../../Redux/Profile/ActiveReselve/ActiveReselve.slice';
import { $profile } from '../../Api/http';
import SuccessfulActiveReselve from '../../components/ActiveReselve/Successful';
import { useNavigate } from 'react-router-dom';
import LoadingSmall from '../../components/Loading/LoadingSmall';
import style from './ActiveReservation.module.css'


export default function ActiveReselve() {
  const navigate = useNavigate()
  const dispatch = useDispatch();
  const { checkData } = useSelector((state) => state.ActiveReselve);
  const { messageCompleted, loading } = useSelector((state) => state.ActiveReselve);


  useEffect(() => {
    fetchCheck();
  }, [localStorage.getItem('access')]);

  useEffect(() => {
    if (!localStorage.getItem('access')) {
      navigate('/login');
    }
    if (checkData !== null) {
      fetchProfile();
    }
  }, [checkData]);

  const fetchCheck = async () => {
    try {
      dispatch(setLoading(true));
      dispatch(setMessageCompleted(null))
      const response = await $profile.get('profile', {
        headers: {
          Authorization: `JWT ${localStorage.getItem('access')}`,
        },
      });
      dispatch(setCheckData(response.data.reservation));
      dispatch(setLoading(false));
    } catch (error) {
      dispatch(setLoading(false));
    }
  };


  const fetchProfile = async () => {
    try {
      dispatch(setLoading(true));
      const response = await $profile.get('profile', {
        headers: {
          Authorization: `JWT ${localStorage.getItem('access')}`,
        },
      });
      dispatch(setInfoActiveReselve(response.data));
      dispatch(setNumberPlace(response.data.reservation.place.name));
      dispatch(setRoom(response.data.room[0].name));
      dispatch(setDateStart(response.data.reservation.start_date.split(' ').join(', ')));
      dispatch(setDateEnd(response.data.reservation.end_date.split(' ').join(', ')));
      dispatch(setFirstName(response.data.reservation.user.first_name));
      dispatch(
        setRemainingTime(
          response.data.reservation.remaining_time.replace(
            /(\d{2}):(\d{2}):(\d{2})/,
            `$1д $2ч $3мин`,
          ),
        ),
      );
      dispatch(setDeleteReservation(response.data.reservation.id));
      dispatch(setLoading(false));
    } catch (error) {
      setLoading(false);
    }
  };

  return (
    <div className="w-full flex items-center justify-center mt-[40px]">
      {
        loading ? <LoadingSmall /> :
        checkData === null ? 
          <p className="text-[28px] font-bold">Нет активной брони</p>
          :
          <div
        className={
          checkData === null
            ? 'bg-purple-color h-[100vh] overflow-hidden w-full max-w-[1330px] rounded-[8px] p-[20px] relative flex items-center justify-center'
            : 'bg-purple-color h-auto overflow-hidden w-full max-w-[1330px] rounded-[8px] p-[20px] relative'
        }>
          {
            messageCompleted && <SuccessfulActiveReselve />
          }
           
          <>
            <svg
              className={`${style.svg} absolute right-0 top-[60px]`}
              width="524"
              height="597"
              viewBox="0 0 524 597"
              fill="none"
              xmlns="http://www.w3.org/2000/svg">
              <path
                d="M189.562 101.599L174.966 141.7L143.332 130.187L158.102 89.6058L141.38 2.82381L174.771 14.9772L185.126 69.0453L227.813 34.2831L258.489 45.448L189.562 101.599ZM276.576 181.216C264.753 176.913 255.013 170.534 247.356 162.077C239.805 153.66 234.922 144.042 232.708 133.225C230.6 122.446 231.562 111.518 235.594 100.441C239.625 89.3637 245.913 80.3741 254.456 73.472C263.106 66.6087 273.028 62.3798 284.223 60.7852C295.525 59.2295 307.087 60.6032 318.909 64.9063C330.732 69.2094 340.419 75.5697 347.97 83.9872C355.627 92.4435 360.51 102.061 362.618 112.84C364.832 123.657 363.924 134.605 359.892 145.682C355.86 156.759 349.519 165.729 340.87 172.592C332.327 179.495 322.404 183.723 311.103 185.279C299.908 186.874 288.399 185.519 276.576 181.216ZM286.113 155.015C291.758 157.069 297.355 157.599 302.904 156.603C308.453 155.607 313.431 153.197 317.839 149.373C322.285 145.443 325.651 140.336 327.939 134.052C330.226 127.768 330.91 121.744 329.992 115.982C329.113 110.114 326.867 105.014 323.257 100.685C319.646 96.3548 315.018 93.1626 309.373 91.108C303.728 89.0534 298.131 88.5239 292.581 89.5197C287.032 90.5155 282.035 92.9786 277.589 96.9089C273.181 100.733 269.834 105.787 267.547 112.071C265.26 118.355 264.556 124.431 265.435 130.3C266.354 136.062 268.618 141.108 272.229 145.438C275.84 149.768 280.468 152.96 286.113 155.015ZM406.898 228.65C390.282 222.602 378.989 213.365 373.018 200.939C367.153 188.552 367.244 174.05 373.292 157.434L395.854 95.4449L427.488 106.959L405.275 167.99C398.762 185.883 402.588 197.408 416.754 202.564C430.814 207.682 441.1 201.293 447.613 183.399L469.826 122.368L500.981 133.708L478.418 195.697C472.371 212.313 463.066 223.461 450.504 229.142C438.049 234.861 423.514 234.697 406.898 228.65ZM541.41 241.422L524.155 235.141L513.339 264.858L481.705 253.344L522.411 141.508L573.536 160.116C583.654 163.799 591.821 168.701 598.037 174.823C604.291 180.839 608.298 187.725 610.058 195.482C611.857 203.133 611.225 211.166 608.162 219.58C605.216 227.675 600.721 234.06 594.677 238.736C588.778 243.343 581.693 246.072 573.423 246.922L584.755 290.851L550.884 278.523L541.41 241.422ZM576.209 207.95C578.109 202.731 577.931 198.083 575.676 194.005C573.421 189.927 569.044 186.706 562.547 184.342L544.973 177.945L533.052 210.697L550.626 217.094C557.124 219.458 562.527 219.857 566.837 218.29C571.185 216.616 574.309 213.169 576.209 207.95ZM281.248 209.101L204.275 307.738L170.405 295.41L173.768 219.557L126.629 279.477L92.7583 267.149L97.1964 142.112L129.789 153.975L126.323 233.59L175.961 170.78L205.039 181.364L201.34 261.618L251.052 198.111L281.248 209.101ZM305.9 347.259C294.078 342.956 284.337 336.577 276.68 328.12C269.129 319.703 264.246 310.085 262.032 299.268C259.924 288.489 260.886 277.561 264.918 266.484C268.95 255.407 275.237 246.417 283.78 239.515C292.43 232.652 302.352 228.423 313.547 226.828C324.849 225.273 336.411 226.646 348.234 230.949C360.056 235.253 369.743 241.613 377.294 250.03C384.952 258.487 389.834 268.104 391.942 278.883C394.157 289.7 393.248 300.648 389.216 311.725C385.184 322.802 378.844 331.772 370.194 338.636C361.651 345.538 351.728 349.767 340.427 351.322C329.232 352.917 317.723 351.563 305.9 347.259ZM315.437 321.058C321.082 323.112 326.679 323.642 332.228 322.646C337.777 321.65 342.756 319.24 347.163 315.417C351.609 311.486 354.976 306.379 357.263 300.095C359.55 293.811 360.235 287.788 359.316 282.025C358.437 276.157 356.192 271.057 352.581 266.728C348.97 262.398 344.342 259.206 338.697 257.151C333.052 255.096 327.455 254.567 321.906 255.563C316.357 256.559 311.359 259.022 306.913 262.952C302.506 266.776 299.158 271.83 296.871 278.114C294.584 284.398 293.88 290.475 294.76 296.343C295.678 302.105 297.942 307.151 301.553 311.481C305.164 315.811 309.792 319.003 315.437 321.058ZM445.136 361.751L427.882 355.471L417.066 385.187L385.432 373.674L426.137 261.837L477.262 280.445C487.381 284.128 495.548 289.03 501.763 295.152C508.017 301.168 512.024 308.054 513.784 315.812C515.583 323.462 514.951 331.495 511.889 339.909C508.943 348.004 504.447 354.389 498.403 359.065C492.504 363.673 485.42 366.401 477.15 367.251L488.481 411.18L454.611 398.853L445.136 361.751ZM479.936 328.279C481.835 323.06 481.657 318.412 479.402 314.334C477.147 310.257 472.771 307.036 466.274 304.671L448.699 298.274L436.779 331.026L454.353 337.423C460.85 339.788 466.254 340.186 470.563 338.619C474.912 336.945 478.036 333.498 479.936 328.279ZM561.604 391.838L545.187 400.157L535.011 428.116L503.697 416.718L544.402 304.882L575.716 316.279L558.794 362.771L619.013 332.038L653.842 344.715L590.122 377.611L615.533 457.424L578.787 444.049L561.604 391.838ZM107.014 301.056C117.133 304.739 125.3 309.641 131.515 315.763C137.769 321.779 141.776 328.665 143.536 336.422C145.335 344.073 144.703 352.106 141.641 360.52C138.578 368.934 133.899 375.494 127.603 380.198C121.307 384.903 113.811 387.602 105.115 388.297C96.4571 388.885 87.0691 387.338 76.9505 383.655L57.459 376.561L46.8175 405.798L15.1837 394.284L55.8889 282.448L107.014 301.056ZM84.1048 358.034C90.6019 360.398 96.0054 360.797 100.315 359.229C104.664 357.555 107.788 354.109 109.687 348.89C111.587 343.671 111.409 339.023 109.154 334.945C106.899 330.867 102.523 327.646 96.0256 325.281L78.4512 318.885L66.5304 351.637L84.1048 358.034ZM172.125 324.754L203.759 336.268L172.184 423.021L225.546 442.443L216.416 467.527L131.42 436.591L172.125 324.754ZM313.021 478.081L265.73 460.869L249.035 479.399L216.762 467.653L306.835 373.784L337.989 385.124L346.812 514.987L313.9 503.008L313.021 478.081ZM312.245 451.383L310.891 410.362L283.487 440.916L312.245 451.383ZM409.164 540.214C397.448 535.95 387.795 529.662 380.205 521.351C372.761 512.973 367.985 503.394 365.877 492.615C363.769 481.836 364.75 470.855 368.821 459.671C372.891 448.488 379.198 439.445 387.741 432.543C396.284 425.641 406.081 421.426 417.131 419.9C428.326 418.305 439.781 419.64 451.497 423.904C461.722 427.626 470.277 432.79 477.16 439.396C484.043 446.003 488.96 453.703 491.911 462.497L465.152 473.383C461.088 462.013 453.89 454.448 443.558 450.687C437.487 448.478 431.571 447.832 425.809 448.75C420.153 449.707 415.102 452.151 410.656 456.081C406.355 459.944 403.061 465.017 400.774 471.301C398.487 477.586 397.73 483.643 398.503 489.473C399.421 495.235 401.739 500.3 405.456 504.669C409.28 509.076 414.227 512.384 420.298 514.594C430.63 518.354 441.007 517.186 451.428 511.088L464.93 536.628C457.016 541.468 448.3 544.206 438.781 544.842C429.261 545.479 419.389 543.936 409.164 540.214ZM570.858 568.851L561.961 593.295L472.172 560.614L512.877 448.778L600.589 480.702L591.692 505.147L535.295 484.62L528.433 503.472L578.12 521.557L569.514 545.202L519.827 527.117L512.384 547.568L570.858 568.851Z"
                fill="#232835"
              />
            </svg>
            <div className="flex items-center justify-between mb-[20px]">
              <h4 className="text-[30px] font-bold">Активная бронь</h4>
              <svg
                width="30"
                height="30"
                viewBox="0 0 30 30"
                fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M30 15C30 23.2843 23.2843 30 15 30C6.71573 30 0 23.2843 0 15C0 6.71573 6.71573 0 15 0C23.2843 0 30 6.71573 30 15ZM22.5569 9.31813C22.0077 8.76896 21.1173 8.76896 20.5681 9.31813C20.5549 9.33139 20.5424 9.34544 20.5308 9.3602L14.0201 17.6564L10.0948 13.731C9.54559 13.1819 8.6552 13.1819 8.10603 13.731C7.55686 14.2802 7.55686 15.1706 8.10603 15.7198L13.0681 20.6819C13.6173 21.231 14.5077 21.231 15.0569 20.6819C15.0691 20.6696 15.0806 20.6567 15.0914 20.6432L22.5768 11.2865C23.1059 10.7359 23.0993 9.86057 22.5569 9.31813Z"
                  fill="#F64343"
                />
              </svg>
            </div>

            <div className="flex gap-[20px] mb-[20px] flex-wrap">
              <NumberPlace />
              <InfoPlace />
            </div>
            <p className="text-[#94989F] font-medium text-[14px]">
              Вы не можете забронировать больше одного места, <br /> чтобы создать новую бронь,
              завершите предыдущую.
            </p>
          </>
        )
      </div>
      }
    </div>
  );
}
